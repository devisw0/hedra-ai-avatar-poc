<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>LiveKit Avatar POC</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <h1>LiveKit Avatar POC</h1>
    <video id="video" autoplay playsinline controls muted style="width:600px;"></video>

    <script src="https://cdn.jsdelivr.net/npm/livekit-client@latest/dist/livekit-client.umd.js"></script>
    <script>
        const livekitUrl = "wss://magic-mirror-q5ywtzo4.livekit.cloud";
        const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJBUEkyNnZqb01xRjhUUDkiLCJzdWIiOiJBUEkyNnZqb01xRjhUUDkiLCJpYXQiOjE3NTQyNDE2MzEsImV4cCI6MTc1NDI0NTIzMSwiaWRlbnRpdHkiOiJkZXZhbiIsInZpZGVvIjp7InJvb21Kb2luIjp0cnVlLCJyb29tIjoiZGVmYXVsdCJ9fQ.qM0BrnooTHtlAB0fB0k64B_IQ69FBVcHmNsMikJ8tYI";
        
        console.log("üîë Working solution loaded:", new Date().toLocaleTimeString());
        console.log("Token ends with:", token.substring(token.length - 20));
        
        async function connect() {
            try {
                console.log("üîó Connecting to LiveKit...");
                
                const { Room, LocalAudioTrack } = LivekitClient;
                const room = new Room();

                room.onTrackSubscribed = (track) => {
                    console.log("üìπ Track subscribed:", track.kind);
                    if (track.kind === "video") {
                        track.attach(document.getElementById("video"));
                        console.log("‚úÖ Video track attached");
                    }
                };

                room.onConnected = async () => {
                    console.log("‚úÖ Connected to LiveKit room");
                    
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        console.log("üé§ Microphone access granted");
                        
                        const audioTrack = await LocalAudioTrack.create(stream);
                        await room.localParticipant.publishTrack(audioTrack);
                        console.log("üì§ Audio track published");
                        
                    } catch (error) {
                        console.error("‚ùå Failed to access microphone:", error);
                    }
                };

                room.onDisconnected = (reason) => {
                    console.log("‚ùå Disconnected:", reason);
                };

                await room.connect(livekitUrl, token);
            } catch (error) {
                console.error("‚ùå Connection failed:", error);
            }
        }

        window.addEventListener('load', () => {
            if (typeof LivekitClient === 'undefined') {
                console.error('‚ùå LivekitClient not found');
                return;
            }
            
            console.log('‚úÖ LivekitClient ready');
            connect();
        });
    </script>
</body>
</html> 