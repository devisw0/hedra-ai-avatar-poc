<!DOCTYPE html>
<html>
  <head><meta charset="utf-8"><title>Avatar POC</title></head>
  <body>
    <h1>Avatar POC Room</h1>
    <video id="video" autoplay playsinline controls muted style="width:600px;"></video>

    <script src="https://cdn.jsdelivr.net/npm/livekit-client@latest/dist/livekit-client.umd.js?v=2"></script>
    <script>
      const livekitUrl = "wss://magic-mirror-q5ywtzo4.livekit.cloud"; // ‚Üê your LiveKit URL
      const token      = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJBUEkyNnZqb01xRjhUUDkiLCJzdWIiOiJBUEkyNnZqb01xRjhUUDkiLCJpYXQiOjE3NTQyMzk0MDMsImV4cCI6MTc1NDI0MzAwMywiaWRlbnRpdHkiOiJkZXZhbiIsInZpZGVvIjp7InJvb21Kb2luIjp0cnVlLCJyb29tIjoiZGVmYXVsdCJ9fQ.tPIFJjF6OiIKfuD7obY132uLjtePhOweVoGTr9s_Dec";              // ‚Üê output of generate_token.py

      async function connect() {
        try {
          console.log("üîó Attempting to connect to LiveKit...");
          console.log("URL:", livekitUrl);
          console.log("Token:", token.substring(0, 50) + "...");
          
          const { Room, LocalAudioTrack } = LivekitClient;
          const room = new Room();
          
          room.onTrackSubscribed = (track, _, __) => {
            console.log("üìπ Track subscribed:", track.kind);
            if (track.kind === "video") {
              track.attach(document.getElementById("video"));
              console.log("‚úÖ Video track attached to player");
            }
          };
          
          room.onConnected = async () => {
            console.log("‚úÖ Connected to LiveKit room");
            
            // Get user media (microphone)
            try {
              const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
              console.log("üé§ Microphone access granted");
              
              // Publish audio track
              const audioTrack = await LocalAudioTrack.create(stream);
              await room.localParticipant.publishTrack(audioTrack);
              console.log("üì§ Audio track published to LiveKit");
              
            } catch (error) {
              console.error("‚ùå Failed to access microphone:", error);
            }
          };
          
          room.onDisconnected = (reason) => {
            console.log("‚ùå Disconnected:", reason);
          };
          
          await room.connect(livekitUrl, token);
        } catch (error) {
          console.error("‚ùå Connection failed:", error);
        }
      }
      
      // Wait for page to load, then connect
      // Force cache bypass
      const timestamp = Date.now();
      console.log('üîÑ Cache bypass timestamp:', timestamp);
      
      window.addEventListener('load', () => {
        // Check if LiveKit library loaded
        if (typeof LivekitClient === 'undefined') {
          console.error('‚ùå LivekitClient global not found ‚Äî did the UMD script load?');
          document.body.insertAdjacentHTML(
            'beforeend',
            '<p style="color:red;">LiveKit client failed to load.</p>'
          );
          return;
        }
        console.log('‚úÖ LivekitClient is available:', LivekitClient);
        connect();
      });
    </script>
  </body>
</html>
